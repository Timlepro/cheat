local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer

if localPlayer.UserId ~= 10280088666 then
	script:Destroy()
	return
end

local folder = Instance.new("Folder")
folder.Name = "Tracers_LocalOnly"
folder.Parent = workspace

local dots = {}
local atts = {}
local beams = {}
local localAtt = nil

-- Toggles
local beamsVisible = true
local aimEnabled = false

-- Camera aim data
local camConn = nil
local savedCamType, savedCamSubject = nil, nil
local localOffset = Vector3.new(0, 2, 10) -- fallback
local nextScan = 0
local currentTargetHead = nil
local currentNameGui = nil

-- -------------------- Utils --------------------

local function getHead(char)
	if not char then return nil end
	return char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart")
end

local function clearFor(plr)
	if beams[plr] then beams[plr]:Destroy() beams[plr] = nil end
	if dots[plr] then dots[plr]:Destroy() dots[plr] = nil end
	atts[plr] = nil
end

-- -------------------- Dot + Attachment (dans la tête) --------------------

local function makeDot(char, plr)
	local head = getHead(char) or (char and char:WaitForChild("Head", 10))
	if not head then return nil end

	local old = head:FindFirstChild("TracerDot")
	if old then old:Destroy() end

	local gui = Instance.new("BillboardGui")
	gui.Name = "TracerDot"
	gui.Adornee = head
	gui.AlwaysOnTop = true
	gui.Size = UDim2.new(0, 16, 0, 16)
	gui.StudsOffsetWorldSpace = Vector3.new(0, 0, 0) -- dans la tête
	gui.Parent = head

	local txt = Instance.new("TextLabel")
	txt.BackgroundTransparency = 1
	txt.Size = UDim2.new(1, 0, 1, 0)
	txt.Text = "●"
	txt.Font = Enum.Font.GothamBold
	txt.TextScaled = true
	txt.TextColor3 = Color3.fromRGB(255, 255, 255)
	txt.Parent = gui

	dots[plr] = gui
	return gui
end

local function makeAttachment(char, plr)
	local head = getHead(char) or (char and char:WaitForChild("Head", 10))
	if not head then return nil end

	local old = head:FindFirstChild("TracerAtt")
	if old then old:Destroy() end

	local att = Instance.new("Attachment")
	att.Name = "TracerAtt"
	att.Position = Vector3.new(0, 0, 0) -- dans la tête
	att.Parent = head

	atts[plr] = att
	return att
end

-- -------------------- Beams --------------------

local function makeBeamTo(plr)
	if plr == localPlayer then return end
	if beams[plr] then beams[plr]:Destroy() beams[plr] = nil end
	if not localAtt then return end

	local targetAtt = atts[plr]
	if not targetAtt then return end

	local beam = Instance.new("Beam")
	beam.Name = "TracerBeam_" .. plr.UserId
	beam.Attachment0 = localAtt
	beam.Attachment1 = targetAtt
	beam.FaceCamera = true
	beam.Width0 = 0.10
	beam.Width1 = 0.10
	beam.Transparency = NumberSequence.new(0)
	beam.LightEmission = 1
	beam.Color = ColorSequence.new(Color3.fromRGB(255, 0, 0)) -- rouge
	beam.Enabled = beamsVisible
	beam.Parent = folder

	beams[plr] = beam
end

local function rebuildBeams()
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= localPlayer then
			makeBeamTo(plr)
		end
	end
end

local function setBeamsVisible(on)
	beamsVisible = on
	for _, b in pairs(beams) do
		if b then b.Enabled = on end
	end
end

-- -------------------- Name GUI (pseudo sur la cible) --------------------

local function destroyNameGui()
	if currentNameGui then
		currentNameGui:Destroy()
		currentNameGui = nil
	end
end

local function createNameGuiForHead(head)
	destroyNameGui()

	local plr = Players:GetPlayerFromCharacter(head.Parent)
	if not plr then return end

	local gui = Instance.new("BillboardGui")
	gui.Name = "TargetName_LocalOnly"
	gui.Adornee = head
	gui.AlwaysOnTop = true
	gui.Size = UDim2.new(0, 260, 0, 46)
	gui.StudsOffsetWorldSpace = Vector3.new(0, 3, 0)
	gui.Parent = head

	local txt = Instance.new("TextLabel")
	txt.BackgroundTransparency = 1
	txt.Size = UDim2.new(1, 0, 1, 0)
	txt.Font = Enum.Font.GothamBold
	txt.TextScaled = true
	txt.TextColor3 = Color3.fromRGB(255, 255, 255)
	txt.TextStrokeTransparency = 0.2
	txt.Text = plr.Name
	txt.Parent = gui

	currentNameGui = gui
end

local function setTargetHead(head)
	if currentTargetHead == head then return end
	currentTargetHead = head

	if head and head.Parent then
		createNameGuiForHead(head)
	else
		destroyNameGui()
	end
end

-- -------------------- Closest target --------------------

local function getClosestOtherHead()
	local myChar = localPlayer.Character
	local myHead = getHead(myChar)
	if not myHead then return nil end

	local bestHead = nil
	local bestDist = math.huge

	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= localPlayer then
			local head = getHead(plr.Character)
			if head then
				local d = (head.Position - myHead.Position).Magnitude
				if d < bestDist then
					bestDist = d
					bestHead = head
				end
			end
		end
	end

	return bestHead
end

-- -------------------- Camera Aim (tourne vers la cible) --------------------

local function enableAim()
	if aimEnabled then return end
	aimEnabled = true

	local cam = workspace.CurrentCamera
	savedCamType = cam.CameraType
	savedCamSubject = cam.CameraSubject

	-- On passe en scriptable pour forcer l'orientation
	cam.CameraType = Enum.CameraType.Scriptable

	-- Calcul de ton offset caméra actuel par rapport à ta tête (pour garder la même "distance")
	local myHead = getHead(localPlayer.Character)
	if myHead then
		localOffset = myHead.CFrame:VectorToObjectSpace(cam.CFrame.Position - myHead.Position)
	end

	nextScan = 0
	setTargetHead(nil)

	camConn = RunService.RenderStepped:Connect(function()
		if not aimEnabled then return end

		local myHead2 = getHead(localPlayer.Character)
		if not myHead2 then return end

		local now = os.clock()
		if now >= nextScan or (not currentTargetHead) or (not currentTargetHead.Parent) then
			setTargetHead(getClosestOtherHead())
			nextScan = now + 0.12
		end

		-- Position de caméra = ta caméra habituelle (offset conservé)
		local camPos = myHead2.Position + myHead2.CFrame:VectorToWorldSpace(localOffset)

		-- Orientation = vers la cible (si pas de cible, regarde devant toi)
		local lookAtPos
		if currentTargetHead and currentTargetHead.Parent then
			lookAtPos = currentTargetHead.Position
		else
			lookAtPos = myHead2.Position + (myHead2.CFrame.LookVector * 100)
		end

		cam.CFrame = CFrame.new(camPos, lookAtPos)
	end)
end

local function disableAim()
	if not aimEnabled then return end
	aimEnabled = false

	if camConn then
		camConn:Disconnect()
		camConn = nil
	end

	destroyNameGui()
	currentTargetHead = nil

	local cam = workspace.CurrentCamera
	cam.CameraType = savedCamType or Enum.CameraType.Custom

	local char = localPlayer.Character
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	cam.CameraSubject = savedCamSubject or hum
end

local function toggleAim()
	if aimEnabled then
		disableAim()
	else
		enableAim()
	end
end

-- -------------------- Setup players --------------------

local function setupPlayer(plr)
	plr.CharacterAdded:Connect(function(char)
		task.wait(0.1)
		makeDot(char, plr)
		local att = makeAttachment(char, plr)

		if plr == localPlayer then
			localAtt = att
			rebuildBeams()
		else
			makeBeamTo(plr)
		end
	end)

	plr.CharacterRemoving:Connect(function()
		clearFor(plr)

		if plr == localPlayer then
			localAtt = nil
			for p, b in pairs(beams) do
				if b then b:Destroy() end
				beams[p] = nil
			end
		end
	end)
end

for _, plr in ipairs(Players:GetPlayers()) do
	setupPlayer(plr)
	if plr.Character then
		task.spawn(function()
			makeDot(plr.Character, plr)
			local att = makeAttachment(plr.Character, plr)
			if plr == localPlayer then
				localAtt = att
			end
		end)
	end
end

Players.PlayerAdded:Connect(function(plr)
	setupPlayer(plr)
end)

Players.PlayerRemoving:Connect(function(plr)
	clearFor(plr)
	if currentTargetHead and plr.Character and currentTargetHead:IsDescendantOf(plr.Character) then
		setTargetHead(nil)
	end
end)

task.delay(1, function()
	rebuildBeams()
end)

-- Si tu respawn pendant le lock, on le garde
localPlayer.CharacterAdded:Connect(function()
	if aimEnabled then
		task.wait(0.2)
		disableAim()
		enableAim()
	end
end)

-- -------------------- Keys --------------------

UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if UserInputService:GetFocusedTextBox() then return end

	if input.KeyCode == Enum.KeyCode.L then
		setBeamsVisible(not beamsVisible)
	elseif input.KeyCode == Enum.KeyCode.M then
		toggleAim()
	end
end)
print("Code chargé depuis GitHub ✅")

local p=game:GetService("Players")
p.PlayerAdded:Connect(function(plr)
	print(plr.Name.." vient de rejoindre !")
end)

